<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Bank Details - GoMint</title>

    <style>
        :root {
            --primary: #4f63ff;
            --bg: #f5f7fb;
            --border: #e5e7eb;
            --text: #1f2937;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', Arial, sans-serif;
            background: var(--bg);
        }

        /* HEADER */
        header {
            background: #fff;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
        }

        nav a {
            margin-left: 1.5rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        nav a:hover {
            color: var(--primary);
            background: rgba(79, 99, 255, 0.1);
        }

        /* MAIN CONTAINER */
        .container {
            max-width: 900px;
            margin: 2.5rem auto;
            background: #fff;
            padding: 2.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        /* TITLE */
        h1 {
            text-align: center;
            margin-bottom: 1.8rem;
            font-size: 1.8rem;
        }

        /* PROFILE HEADER */
        .profile-name {
            text-align: center;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* PROFILE SUMMARY CARD */
        .profile-summary {
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            background: #fff;
        }

        .profile-summary p {
            margin: 0.4rem 0;
            font-size: 0.95rem;
            color: #374151;
        }

        /* FORM */
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.2rem;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: #374151;
        }

        label .required {
            color: #dc2626;
            margin-left: 0.2rem;
        }

        input.error,
        select.error {
            border-color: #dc2626 !important;
            background-color: #fef2f2;
        }

        .error-message {
            color: #dc2626;
            font-size: 0.75rem;
            margin-top: 0.2rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        input,
        select {
            width: 100%;
            padding: 0.6rem 0.7rem;
            font-size: 0.9rem;
            border-radius: 0.3rem;
            border: 1px solid var(--border);
            outline: none;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
        }

        /* BUTTON */
        .button-row {
            margin-top: 2rem;
        }

        .btn-primary {
            width: 100%;
            padding: 0.9rem;
            background: var(--primary);
            border: none;
            border-radius: 0.4rem;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:hover {
            opacity: 0.95;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">GoMint</div>
        <nav>
            <a href="customerProfile.html">Profile</a>
            <a href="index.html">Logout</a>
        </nav>
    </header>

    <div class="container">

        <h1>Edit Bank Details</h1>
        <div class="profile-name"></div>

        <!-- PROFILE SUMMARY -->
        <div class="profile-summary">
            <p><strong>Email:</strong> <span id="summaryEmail">-</span></p>
            <p><strong>Mobile Number:</strong> <span id="summaryMobile">-</span></p>

            <hr style="margin:1rem 0">

            <p><strong>Bank:</strong> <span id="summaryBank">-</span></p>
            <p><strong>A/c Holder:</strong> <span id="summaryAcctHolder">-</span></p>
            <p><strong>Account Number:</strong> <span id="summaryAcctNumber">-</span></p>
            <p><strong>Bank Code (IFSC/Routing/Swift):</strong> <span id="summaryIfsc">-</span></p>
            <p><strong>Location:</strong> <span id="summaryLocation">-</span></p>
            <p><strong>Last Updated:</strong> <span id="summaryLastUpdated">-</span></p>
        </div>

        <!-- EDIT FORM -->
        <form>

            <div class="form-row">
                <div class="form-group">
                    <label>A/c Holder Name<span class="required">*</span></label>
                    <input type="text" id="acctHolder" placeholder="Enter account holder name">
                    <div class="error-message">This field is required</div>
                </div>
                <div class="form-group">
                    <label>Bank Name<span class="required">*</span></label>
                    <input type="text" id="bankName" placeholder="Enter bank name">
                    <div class="error-message">This field is required</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>A/c Number<span class="required">*</span></label>
                    <input type="password" id="acctNumber" placeholder="Enter account number">
                    <div class="error-message">This field is required</div>
                </div>
                <div class="form-group">
                    <label>Confirm A/c Number<span class="required">*</span></label>
                    <input type="password" id="confirmAcctNumber" placeholder="Confirm account number">
                    <div class="error-message">This field is required</div>
                </div>
            </div>

            <div class="form-group">
                <label>Bank Code (IFSC/Routing/Swift)<span class="required">*</span></label>
                <input type="text" id="ifsc" placeholder="Enter bank code">
                <div class="error-message">This field is required</div>
            </div>

            <hr style="margin:1.5rem 0">

            <div class="form-row">
                <div class="form-group">
                    <label>Country</label>
                    <select id="country">
                        <option value="">Select Country</option>
                        <option>United States</option>
                        <option>India</option>
                        <option>United Kingdom</option>
                        <option>Australia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>State</label>
                    <select id="state">
                        <option value="">Select State</option>
                        <option>California</option>
                        <option>New York</option>
                        <option>Texas</option>
                    </select>
                </div>
            </div>

            <div class="button-row">
                <button type="button" class="btn-primary" onclick="saveBankDetails()">
                    Update Bank Details
                </button>
            </div>

        </form>

    </div>

    <script>
        // Extract customer ID from token
        function getCustomerId() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'customerLogin.html';
                return null;
            }

            try {
                // Token is stored as btoa(JSON) from login
                const decoded = JSON.parse(atob(token));
                return decoded.sub; // sub contains the customer ID
            } catch (err) {
                console.error('Failed to decode token:', err);
                localStorage.removeItem('token');
                window.location.href = 'customerLogin.html';
                return null;
            }
        }

        // Load profile info and bank data
        window.onload = function () {
            const customerId = getCustomerId();
            if (!customerId) return;

            // Load profile data from API
            const token = localStorage.getItem('token');
            fetch(`http://localhost:3001/api/customers/${customerId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch profile');
                    return response.json();
                })
                .then(profileData => {
                    // Store profile data in localStorage for later use
                    localStorage.setItem('profile', JSON.stringify(profileData));

                    // Update profile name
                    const fullName = `${profileData.firstName || ''} ${profileData.lastName || ''}`.trim();
                    document.querySelector('.profile-name').textContent = fullName || 'Customer';

                    // Load bank data from API or localStorage
                    let bankData = {};
                    if (profileData.bankDetails) {
                        bankData = profileData.bankDetails;
                    } else {
                        bankData = JSON.parse(localStorage.getItem('bank')) || {};
                    }

                    // Update profile summary with dynamic data from actual sources
                    document.getElementById('summaryEmail').textContent = profileData.email || '-';
                    document.getElementById('summaryMobile').textContent = profileData.mobile || '-';
                    document.getElementById('summaryBank').textContent = bankData.bankName || '-';
                    document.getElementById('summaryAcctHolder').textContent = bankData.acctHolder || '-';
                    document.getElementById('summaryAcctNumber').textContent = bankData.acctNumber ? '****' + bankData.acctNumber.slice(-4) : '-';
                    document.getElementById('summaryIfsc').textContent = bankData.ifsc || '-';
                    document.getElementById('summaryLocation').textContent = `${bankData.state || ''} ${bankData.country || ''}`.trim() || '-';
                    document.getElementById('summaryLastUpdated').textContent = bankData.lastUpdated || new Date().toLocaleDateString();

                    // Do NOT pre-fill form fields - let user enter fresh data
                    document.getElementById('country').value = '';
                    document.getElementById('state').value = '';
                })
                .catch(err => {
                    console.error('Error loading profile:', err);
                    alert('Failed to load profile data');
                });
        }

        function saveBankDetails() {
            const customerId = getCustomerId();
            if (!customerId) return;

            // Clear previous errors
            document.querySelectorAll('input, select').forEach(field => {
                field.classList.remove('error');
                field.parentElement.querySelector('.error-message')?.classList.remove('show');
            });

            const profileData = JSON.parse(localStorage.getItem('profile')) || {};
            const acctHolder = document.getElementById('acctHolder').value.trim();
            const bankName = document.getElementById('bankName').value.trim();
            const acctNumber = document.getElementById('acctNumber').value.trim();
            const confirmAcctNumber = document.getElementById('confirmAcctNumber').value.trim();
            const ifsc = document.getElementById('ifsc').value.trim();
            const country = document.getElementById('country').value;
            const state = document.getElementById('state').value;

            let hasErrors = false;

            // Validation with field highlighting
            if (!acctHolder) {
                document.getElementById('acctHolder').classList.add('error');
                document.getElementById('acctHolder').parentElement.querySelector('.error-message').classList.add('show');
                hasErrors = true;
            }

            if (!bankName) {
                document.getElementById('bankName').classList.add('error');
                document.getElementById('bankName').parentElement.querySelector('.error-message').classList.add('show');
                hasErrors = true;
            }

            if (!acctNumber) {
                document.getElementById('acctNumber').classList.add('error');
                document.getElementById('acctNumber').parentElement.querySelector('.error-message').classList.add('show');
                hasErrors = true;
            }

            if (!confirmAcctNumber) {
                document.getElementById('confirmAcctNumber').classList.add('error');
                document.getElementById('confirmAcctNumber').parentElement.querySelector('.error-message').classList.add('show');
                hasErrors = true;
            }

            if (!ifsc) {
                document.getElementById('ifsc').classList.add('error');
                document.getElementById('ifsc').parentElement.querySelector('.error-message').classList.add('show');
                hasErrors = true;
            }

            if (hasErrors) return;

            if (acctNumber !== confirmAcctNumber) {
                document.getElementById('confirmAcctNumber').classList.add('error');
                const errorMsg = document.getElementById('confirmAcctNumber').parentElement.querySelector('.error-message');
                errorMsg.textContent = 'Account numbers do not match';
                errorMsg.classList.add('show');
                return;
            }

            const bankData = {
                acctHolder: acctHolder,
                bankName: bankName,
                acctNumber: acctNumber,
                ifsc: ifsc,
                state: state,
                country: country,
                lastUpdated: new Date().toLocaleDateString()
            };

            // Save bank details and updated profile to database
            const profileUpdateData = {
                firstName: profileData.firstName,
                lastName: profileData.lastName,
                email: profileData.email,
                mobile: profileData.mobile,
                country: country,
                bankDetails: bankData
            };

            const token = localStorage.getItem('token');
            fetch(`http://localhost:3001/api/customers/${customerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(profileUpdateData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to update bank details');
                    return response.json();
                })
                .then(updatedData => {
                    // Store updated data in localStorage
                    localStorage.setItem('bank', JSON.stringify(bankData));
                    localStorage.setItem('profile', JSON.stringify(updatedData));

                    window.location.href = 'businessUpdateDetails.html';
                })
                .catch(err => {
                    console.error('Error saving bank details:', err);
                    alert('Failed to save bank details. Please try again.');
                });
        }
    </script>

</body>

</html>